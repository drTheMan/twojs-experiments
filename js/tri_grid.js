// Generated by CoffeeScript 1.6.3
(function() {
  var PerspectiveSquare, TriGrid, TriGridCoords, Triad, _ref,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  Triad = (function() {
    function Triad(_opts) {
      this.options = _opts;
      this._init();
    }

    Triad.prototype._init = function() {
      return this.polygon = this._createPolygon();
    };

    Triad.prototype._sideLength = function() {
      return this.options.sideLength || 50;
    };

    Triad.prototype._halfSide = function() {
      return this._sideLength() / 2;
    };

    Triad.prototype._centerLength = function() {
      return this.__centerLength || (this.__centerLength = Math.sqrt(Math.pow(this._sideLength(), 2) - Math.pow(this._halfSide(), 2)));
    };

    Triad.prototype._createPolygon = function() {
      return new Two.Polygon(this.anchors(), true, false);
    };

    Triad.prototype.anchor1 = function() {
      return new Two.Anchor(0, 0);
    };

    Triad.prototype.anchor2 = function() {
      return new Two.Anchor(this._halfSide(), this._centerLength());
    };

    Triad.prototype.anchor3 = function() {
      return new Two.Anchor(-this._halfSide(), this._centerLength());
    };

    Triad.prototype.anchors = function() {
      return [this.anchor1(), this.anchor2(), this.anchor3()];
    };

    return Triad;

  })();

  PerspectiveSquare = (function(_super) {
    __extends(PerspectiveSquare, _super);

    function PerspectiveSquare() {
      _ref = PerspectiveSquare.__super__.constructor.apply(this, arguments);
      return _ref;
    }

    PerspectiveSquare.prototype.anchor4 = function() {
      return new Two.Anchor(-this._sideLength(), 0);
    };

    PerspectiveSquare.prototype.anchors = function() {
      return [this.anchor1(), this.anchor2(), this.anchor3(), this.anchor4()];
    };

    return PerspectiveSquare;

  })(Triad);

  TriGrid = (function(_super) {
    __extends(TriGrid, _super);

    function TriGrid(_opts) {
      this.options = _opts;
      this.two = this.options.two;
      this._init();
    }

    TriGrid.prototype._init = function() {
      var _this = this;
      this.group = this.two.makeGroup();
      this.group.translation.set(0, 0);
      _.each(this.createEveryOtherTriad(), function(t) {
        return t.polygon.addTo(_this.group);
      });
      this.group.noFill();
      this.group.stroke = this._stroke();
      return this.group.lineWidth = 2;
    };

    TriGrid.prototype.destroy = function() {
      this.trigger('destroy');
      this.two.remove(this.group);
      return this.group = void 0;
    };

    TriGrid.prototype._sideLength = function() {
      return this.options.sideLength || 50;
    };

    TriGrid.prototype._halfSide = function() {
      return this._sideLength() / 2;
    };

    TriGrid.prototype._centerLength = function() {
      return this.__centerLength || (this.__centerLength = Math.sqrt(Math.pow(this._sideLength(), 2) - Math.pow(this._halfSide(), 2)));
    };

    TriGrid.prototype._rows = function() {
      return this.options.rows || this.two.height / this._centerLength();
    };

    TriGrid.prototype._cols = function() {
      return this.options.cols || this.two.width / this._sideLength();
    };

    TriGrid.prototype._stroke = function() {
      return this.options.stroke || '#555555';
    };

    TriGrid.prototype.createEveryOtherTriad = function() {
      var _this = this;
      return _.flatten(_.map(_.range(this._rows()), function(ri) {
        return _.map(_.range(_this._cols()), function(ci) {
          var t, x, y;
          x = ci * _this._sideLength();
          if (ri % 2 === 1) {
            x += _this._sideLength() / 2;
          }
          y = ri * _this._centerLength();
          t = new Triad({
            sideLength: _this._sideLength()
          });
          t.polygon.translation.set(x, y);
          return t;
        });
      }));
    };

    TriGrid.prototype.squarePolygon = function(x, y, w, h) {
      var ps;
      ps = new PerspectiveSquare({
        sideLength: this._sideLength()
      });
      ps.polygon.noFill();
      ps.polygon.stroke = this._stroke();
      return ps.polygon;
    };

    TriGrid.prototype.cubePolygon = function(x, y, w, h) {
      var g, p1, p2, p3;
      p1 = this.squarePolygon(x, y, w, h);
      p2 = this.squarePolygon(x, y, w, h);
      p2.rotation = Math.PI * 0.67;
      p3 = this.squarePolygon(x, y, w, h);
      p3.rotation = Math.PI * 0.34;
      p3.translation.x = this._sideLength();
      g = this.two.makeGroup();
      p1.addTo(g);
      p2.addTo(g);
      p3.addTo(g);
      return g;
    };

    return TriGrid;

  })(Backbone.Model);

  TriGridCoords = (function(_super) {
    __extends(TriGridCoords, _super);

    function TriGridCoords(_opts) {
      this.options = _opts;
    }

    TriGridCoords.prototype.sideLength = function() {
      return this.options.sideLength || 50;
    };

    TriGridCoords.prototype.halfSide = function() {
      return this.sideLength() / 2;
    };

    TriGridCoords.prototype.centerLength = function() {
      return this._centerLength || (this._centerLength = Math.sqrt(Math.pow(this._sideLength(), 2) - Math.pow(this._halfSide(), 2)));
    };

    TriGridCoords.prototype.cubePos = function(row, col) {
      return {
        x: this.sideLength() * col + this.halfSide() * row / 2,
        y: this.halfSide() * row
      };
    };

    return TriGridCoords;

  })(Backbone.Model);

  this.TriGridOps = (function(_super) {
    __extends(TriGridOps, _super);

    function TriGridOps(_opts) {
      this.options = _opts;
      this.target = this.options.target || this.options.tri_grid || this.options.trigrid || new TriGrid({
        two: this.options.two
      });
      this.on('travelerComplete', (function(tween, polygon) {
        return this.target.two.remove(polygon);
      }), this);
    }

    TriGridOps.prototype.lonelyTravelerTween = function() {
      var col, coords, duration, p, pos, row, target, targetCol, targetRow, that, tween,
        _this = this;
      coords = new TriGridCoords({
        sideLength: this.target._sideLength()
      });
      row = Math.floor(Math.random(this.target._rows()));
      targetRow = row;
      col = -1;
      targetCol = this.target._cols();
      if (Math.random() > 0.5) {
        col = Math.floor(Math.random(this.target._cols()));
        targetCol = col;
        row = -1;
        targetRow = this.target._rows();
      }
      p = this.target.cubePolygon();
      pos = coords.cubePos(col, row);
      p.translation.set(pos.x, pos.y);
      p.addTo(this.target.group);
      target = coords.cubePos(targetCol, targetRow);
      duration = 5000;
      console.log(p.translation);
      console.log(target);
      that = this;
      tween = new TWEEN.Tween(p.translation).to(target, duration).easing(TWEEN.Easing.Linear.None);
      return tween.onComplete(function() {
        return _this.trigger('travelerComplete', tween, p);
      });
    };

    return TriGridOps;

  })(Backbone.Model);

}).call(this);
