// Generated by CoffeeScript 1.6.3
(function() {
  var Stripe, _ref,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  Stripe = (function(_super) {
    __extends(Stripe, _super);

    function Stripe() {
      _ref = Stripe.__super__.constructor.apply(this, arguments);
      return _ref;
    }

    Stripe.prototype.isDead = function() {
      return this.get('particle').translation.y > this.get('height') * 2;
    };

    Stripe.prototype.update = function() {
      return this.get('particle').translation.addSelf(new Two.Vector(0, 20));
    };

    return Stripe;

  })(Backbone.Model);

  this.StripeRain = (function() {
    function StripeRain(_opts) {
      var _base;
      this.options = _opts;
      this.two = this.options.two;
      (_base = this.options).rotation || (_base.rotation = 0);
      this._init();
    }

    StripeRain.prototype.addOne = function() {
      var pos, size, w;
      this.minSize || (this.minSize = Math.sqrt(Math.pow(this.two.width, 2), Math.pow(this.two.height, 2)));
      this.maxPos || (this.maxPos = _.max([this.two.width, this.two.height]));
      size = this.minSize + Math.random() * 500;
      pos = (Math.random() - 0.5) * this.maxPos;
      w = 25;
      return this.stripes.add(new Stripe({
        x: pos,
        y: -size,
        width: w,
        height: size,
        color: '#54EBFA'
      }));
    };

    StripeRain.prototype.addSome = function() {
      if (this.stripes.length < 30) {
        this.addOne();
        return this.addOne();
      }
    };

    StripeRain.prototype.getAllParticles = function() {
      return this.stripes.map(function(stripe) {
        return stripe.get('particle');
      });
    };

    StripeRain.prototype._init = function() {
      var _this = this;
      this.stripes = new Backbone.Collection([]);
      this.stripes.on('add', this._added, this);
      this.stripes.on('remove', this.addSome, this);
      this.stripes.on('remove', function(stripe) {
        return _this.group.remove(stripe.get('particle'));
      });
      this.two.bind('update', this._update, this);
      this.group = this.two.makeGroup();
      this.group.translation.set(this.two.width / 2, this.two.height / 2);
      if (this.options.rotation) {
        this.group.rotation = this.options.rotation;
      }
      return this.addOne();
    };

    StripeRain.prototype._update = function(frameCount) {
      var _this = this;
      return this.stripes.each(function(stripe, col) {
        if (stripe.isDead()) {
          return _this.stripes.remove(stripe);
        } else {
          return stripe.update();
        }
      });
    };

    StripeRain.prototype._added = function(obj) {
      var group, h, rect, w;
      group = new Two.Group();
      w = obj.get('width');
      h = obj.get('height');
      rect = this.two.makeRectangle(w * 2.8, 0, w, h);
      rect.fill = 'rgba(0, 0, 0, 0.3)';
      rect.addTo(group);
      rect = this.two.makeRectangle(0, 0, w, h);
      rect.fill = '#54EBFA';
      rect.addTo(group);
      rect = this.two.makeRectangle(w - 1, 0, w, h);
      rect.fill = '#FFFFFF';
      rect.addTo(group);
      rect = this.two.makeRectangle(w + w - 1, 0, w, h);
      rect.fill = '#FD031D';
      rect.addTo(group);
      group.translation.addSelf(new Two.Vector(obj.get('x'), obj.get('y')));
      group.noStroke();
      group.addTo(this.group);
      return obj.set({
        particle: group
      });
    };

    return StripeRain;

  })();

}).call(this);
